generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrgUserRole {
  OWNER // Proprietario organizzazione (legacy, equivale ad ADMIN)
  ADMIN // Admin organizzazione - gestisce template ORG, utenti, strutture
  MANAGER // Manager struttura - gestisce scadenze della struttura, non template
  OPERATOR // Operatore - solo visualizzazione e caricamento documenti
}

enum OrganizationType {
  STUDIO_MEDICO
  STUDIO_DENTISTICO
  MEDICO_SINGOLO
}

enum TemplateOwnerType {
  GLOBAL
  ORG
}

enum DeadlineScope {
  ROLE
  STRUCTURE
  PERSON
}

enum RecurrenceUnit {
  DAY
  MONTH
  YEAR
}

enum AnchorType {
  ASSIGNMENT_START
  HIRE_DATE
  LAST_COMPLETION
  CUSTOM
}

enum ComplianceType {
  TRAINING
  MAINTENANCE
  INSPECTION
  DOCUMENT
  REPORTING
  WASTE
  DATA_PROTECTION
  INSURANCE
  OTHER
}

enum DeadlineStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

enum DocumentOwner {
  DEADLINE
  PERSON
  STRUCTURE
  ORGANIZATION
}

enum DocumentScope {
  STRUCTURE
  PERSON
}

enum NotificationType {
  EMAIL
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  emailVerified            DateTime?
  name                     String?
  password                 String?
  image                    String?
  isSuperAdmin             Boolean   @default(false)
  accountStatus            String    @default("PENDING_VERIFICATION") // PENDING_VERIFICATION, PENDING_APPROVAL, APPROVED, REJECTED
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  needsOnboarding          Boolean   @default(false) // true se approvato da Super Admin ma senza organizzazione

  accounts          Account[]
  sessions          Session[]
  organizationUsers OrganizationUser[]
  documents         Document[]
  auditLogs         AuditLog[]
  invitesSent       InviteToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  userId  String
  token   String   @unique
  expires DateTime
  used    Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId, used])
}

model Organization {
  id         String           @id @default(cuid())
  name       String
  type       OrganizationType @default(STUDIO_MEDICO)
  vatNumber  String?
  fiscalCode String?
  address    String?
  city       String?
  province   String?
  postalCode String?
  country    String           @default("IT")
  phone      String?
  email      String?
  pec        String?
  website    String?

  timezone             String  @default("Europe/Rome")
  notificationsEnabled Boolean @default(true)

  users             OrganizationUser[]
  structures        Structure[]
  people            Person[]
  roleTemplates     RoleTemplate[]
  deadlineTemplates DeadlineTemplate[]
  deadlineInstances DeadlineInstance[]
  documentTemplates DocumentTemplate[]
  documents         Document[]
  auditLogs         AuditLog[]
  inviteTokens      InviteToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationUser {
  id             String      @id @default(cuid())
  organizationId String
  userId         String      @unique // Un utente può avere solo 1 organizzazione
  role           OrgUserRole @default(ADMIN) // Ruolo dell'utente nell'organizzazione
  structureId    String? // Se MANAGER/OPERATOR, struttura specifica di competenza

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  structure    Structure?   @relation(fields: [structureId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([organizationId, role])
  @@index([structureId])
}

model Structure {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  code           String?
  address        String?
  city           String?
  province       String?
  postalCode     String?
  phone          String?
  email          String?
  pec            String?
  website        String?

  // Dati fiscali e legali
  vatNumber  String? // Partita IVA della struttura
  fiscalCode String? // Codice Fiscale della struttura

  // Responsabili
  responsiblePersonId String? // ID della persona responsabile della struttura
  legalRepName        String? // Nome rappresentante legale (se diverso dal responsabile)

  // Altri dati utili
  licenseNumber   String? // Numero autorizzazione sanitaria
  licenseExpiry   DateTime? // Scadenza autorizzazione
  insurancePolicy String? // Numero polizza assicurativa
  insuranceExpiry DateTime? // Scadenza polizza

  notes  String?
  active Boolean @default(true)

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  responsiblePerson Person?            @relation("StructureResponsible", fields: [responsiblePersonId], references: [id], onDelete: SetNull)
  personStructures  PersonStructure[]
  roleAssignments   RoleAssignment[]
  deadlineInstances DeadlineInstance[]
  organizationUsers OrganizationUser[] // Utenti assegnati a questa struttura (MANAGER/OPERATOR)
  inviteTokens      InviteToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([responsiblePersonId])
}

model Person {
  id             String    @id @default(cuid())
  organizationId String
  firstName      String
  lastName       String
  fiscalCode     String?
  email          String?
  phone          String?
  hireDate       DateTime?
  birthDate      DateTime?
  notes          String?
  active         Boolean   @default(true)

  organization             Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  structures               PersonStructure[]
  roleAssignments          RoleAssignment[]
  deadlineInstances        DeadlineInstance[]
  responsibleForStructures Structure[]        @relation("StructureResponsible")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

model PersonStructure {
  id          String    @id @default(cuid())
  personId    String
  structureId String
  startDate   DateTime?
  endDate     DateTime?
  isPrimary   Boolean   @default(false)

  person    Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  structure Structure @relation(fields: [structureId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([personId, structureId])
}

model RoleTemplate {
  id             String            @id @default(cuid())
  ownerType      TemplateOwnerType @default(GLOBAL)
  organizationId String?
  key            String
  label          String
  description    String?
  active         Boolean           @default(true)

  organization      Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deadlineTemplates DeadlineTemplate[]
  roleAssignments   RoleAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerType, key])
  @@index([ownerType, active])
}

model DeadlineTemplate {
  id                   String            @id @default(cuid())
  ownerType            TemplateOwnerType @default(GLOBAL)
  organizationId       String?
  scope                DeadlineScope
  complianceType       ComplianceType
  title                String
  description          String?
  recurrenceUnit       RecurrenceUnit?
  recurrenceEvery      Int?
  firstDueOffsetDays   Int               @default(0)
  anchor               AnchorType
  roleTemplateId       String?
  requiredDocumentName String?
  active               Boolean           @default(true)
  status               String            @default("ACTIVE")
  legalReference       String?
  sourceUrl            String?
  effectiveFrom        DateTime?
  effectiveTo          DateTime?
  country              String?           @default("IT")
  regions              String? // JSON array di regioni italiane (es: '["Lombardia","Lazio"]', NULL o '[]' per nazionale)
  notes                String?

  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  roleTemplate RoleTemplate?      @relation(fields: [roleTemplateId], references: [id])
  instances    DeadlineInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, active, scope])
  @@index([organizationId])
}

model DeadlineInstance {
  id                   String          @id @default(cuid())
  organizationId       String
  templateId           String?
  structureId          String?
  personId             String?
  roleAssignmentId     String?
  title                String
  dueDate              DateTime
  status               DeadlineStatus  @default(PENDING)
  completedAt          DateTime?
  completionDocumentId String?
  notes                String?
  complianceType       ComplianceType? // Tipo di compliance per scadenze manuali

  // Campi per la gestione della ricorrenza
  isRecurring       Boolean   @default(false) // Se questa istanza fa parte di una serie ricorrente
  recurrenceActive  Boolean   @default(true) // Se la ricorrenza è ancora attiva
  recurrenceEndDate DateTime? // Data opzionale di fine ricorrenza
  recurrenceGroupId String? // ID per raggruppare tutte le istanze della stessa ricorrenza

  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template       DeadlineTemplate?  @relation(fields: [templateId], references: [id])
  structure      Structure?         @relation(fields: [structureId], references: [id])
  person         Person?            @relation(fields: [personId], references: [id])
  roleAssignment RoleAssignment?    @relation(fields: [roleAssignmentId], references: [id])
  notifications  Notification[]
  reminders      DeadlineReminder[]
  documents      Document[]         @relation("DeadlineDocuments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, dueDate])
  @@index([status, dueDate])
  @@index([templateId])
  @@index([recurrenceGroupId])
}

model RoleAssignment {
  id             String    @id @default(cuid())
  personId       String
  roleTemplateId String
  structureId    String?
  startDate      DateTime?
  endDate        DateTime?

  person       Person             @relation(fields: [personId], references: [id], onDelete: Cascade)
  roleTemplate RoleTemplate       @relation(fields: [roleTemplateId], references: [id])
  structure    Structure?         @relation(fields: [structureId], references: [id])
  deadlines    DeadlineInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([roleTemplateId])
}

model DocumentTemplate {
  id             String            @id @default(cuid())
  ownerType      TemplateOwnerType @default(GLOBAL)
  organizationId String?
  scope          DocumentScope // STRUCTURE o PERSON
  name           String // Nome del documento (es: "DVR", "Assicurazione RC")
  description    String?
  category       String? // Categoria (es: "Sicurezza", "Assicurazioni", "Formazione")
  isMandatory    Boolean           @default(false) // Se è obbligatorio
  hasExpiry      Boolean           @default(false) // Se ha una scadenza
  reminderDays   Int? // Giorni prima della scadenza per il reminder
  fileFormats    String? // Formati file accettati (es: "PDF,DOC,DOCX")
  maxSizeKB      Int? // Dimensione massima in KB
  notes          String?
  legalReference String? // Riferimento normativo
  active         Boolean           @default(true)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents    Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, scope, active])
  @@index([organizationId])
}

model Document {
  id             String        @id @default(cuid())
  organizationId String
  templateId     String? // Collegamento al template (se basato su template)
  ownerType      DocumentOwner @default(DEADLINE)
  ownerId        String // ID di Person, Structure, Deadline, Organization
  deadlineId     String? // Campo esplicito per la relazione con DeadlineInstance
  fileName       String
  fileType       String?
  fileSize       Int?
  storagePath    String
  uploadedById   String?

  // Campi per scadenza documento
  expiryDate DateTime? // Data di scadenza del documento
  isExpired  Boolean   @default(false) // Flag calcolato per documenti scaduti
  notes      String?

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy       User?             @relation(fields: [uploadedById], references: [id])
  documentTemplate DocumentTemplate? @relation(fields: [templateId], references: [id])
  deadline         DeadlineInstance? @relation("DeadlineDocuments", fields: [deadlineId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, ownerType, ownerId])
  @@index([templateId])
  @@index([expiryDate])
}

model Notification {
  id          String             @id @default(cuid())
  deadlineId  String
  sendTo      String
  type        NotificationType   @default(EMAIL)
  scheduledAt DateTime
  sentAt      DateTime?
  status      NotificationStatus @default(PENDING)

  deadline DeadlineInstance @relation(fields: [deadlineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, scheduledAt])
  @@index([deadlineId])
}

model DeadlineReminder {
  id         String    @id @default(cuid())
  deadlineId String
  daysBefore Int // Giorni prima della scadenza per il reminder (es: 7, 3, 1)
  message    String? // Messaggio personalizzato opzionale
  notified   Boolean   @default(false) // Se il reminder è già stato inviato
  notifiedAt DateTime? // Quando è stato inviato il reminder

  deadline DeadlineInstance @relation(fields: [deadlineId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([deadlineId])
  @@index([notified])
}

model AuditLog {
  id             String  @id @default(cuid())
  organizationId String?
  userId         String?
  action         String
  entity         String?
  entityId       String?
  ip             String?
  metadata       Json?

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
}

model InviteToken {
  id             String      @id @default(cuid())
  token          String      @unique @default(cuid())
  email          String
  organizationId String
  role           OrgUserRole
  structureId    String? // Required per MANAGER/OPERATOR
  invitedBy      String // userId dell'Owner/Admin che ha invitato
  expiresAt      DateTime
  usedAt         DateTime?
  usedByUserId   String? // userId che ha usato il token

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  structure    Structure?   @relation(fields: [structureId], references: [id], onDelete: Cascade)
  inviter      User         @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([email])
  @@index([organizationId])
  @@index([usedAt])
}

model ProvinceRegionMapping {
  id           String @id @default(cuid())
  provinceCode String @unique // Sigla provincia (es: "MI", "RM", "NA")
  provinceName String // Nome provincia (es: "Milano", "Roma", "Napoli")
  regionName   String // Nome regione (es: "Lombardia", "Lazio", "Campania")
  country      String @default("IT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provinceCode])
  @@index([regionName])
}
